# üöÄ n8n Queue Mode com Traefik - Setup Completo

[![n8n](https://img.shields.io/badge/n8n-FF6B6B?style=for-the-badge&logo=n8n&logoColor=white)](https://n8n.io/)
[![Traefik](https://img.shields.io/badge/Traefik-24A1C1?style=for-the-badge&logo=traefik&logoColor=white)](https://traefik.io/)
[![Docker](https://img.shields.io/badge/Docker-2496ED?style=for-the-badge&logo=docker&logoColor=white)](https://docker.com/)
[![PostgreSQL](https://img.shields.io/badge/PostgreSQL-336791?style=for-the-badge&logo=postgresql&logoColor=white)](https://postgresql.org/)
[![Redis](https://img.shields.io/badge/Redis-DC382D?style=for-the-badge&logo=redis&logoColor=white)](https://redis.io/)

> **Setup completo do n8n em modo fila (queue) com Traefik como reverse proxy, incluindo SSL autom√°tico e configura√ß√£o para ambiente WSL/Windows.**

## üìã √çndice

- [üìã √çndice](#-√≠ndice)
- [üéØ Sobre o Projeto](#-sobre-o-projeto)
- [‚ú® Caracter√≠sticas](#-caracter√≠sticas)
- [üèóÔ∏è Arquitetura](#Ô∏è-arquitetura)
- [‚öôÔ∏è Pr√©-requisitos](#Ô∏è-pr√©-requisitos)
- [üöÄ Instala√ß√£o e Configura√ß√£o](#-instala√ß√£o-e-configura√ß√£o)
  - [1. Prepara√ß√£o do Ambiente WSL](#1-prepara√ß√£o-do-ambiente-wsl)
  - [2. Clonagem e Configura√ß√£o](#2-clonagem-e-configura√ß√£o)
  - [3. Configura√ß√£o de Vari√°veis de Ambiente](#3-configura√ß√£o-de-vari√°veis-de-ambiente)
  - [4. Configura√ß√£o DNS e Certificados](#4-configura√ß√£o-dns-e-certificados)
  - [5. Configura√ß√£o Espec√≠fica WSL/Windows](#5-configura√ß√£o-espec√≠fica-wslwindows)
  - [6. Inicializa√ß√£o dos Servi√ßos](#6-inicializa√ß√£o-dos-servi√ßos)
- [üîß Uso](#-uso)
- [üåê URLs de Acesso](#-urls-de-acesso)
- [‚ö†Ô∏è Problemas Comuns e Solu√ß√µes](#Ô∏è-problemas-comuns-e-solu√ß√µes)
- [üõ†Ô∏è Manuten√ß√£o](#Ô∏è-manuten√ß√£o)
- [üìä Monitoramento](#-monitoramento)
- [üîí Seguran√ßa](#-seguran√ßa)
- [üìö Refer√™ncias](#-refer√™ncias)
- [ü§ù Contribui√ß√£o](#-contribui√ß√£o)

## üéØ Sobre o Projeto

Este projeto implementa uma instala√ß√£o completa do **n8n** (plataforma de automa√ß√£o de fluxo de trabalho) executando em **modo fila** para alta escalabilidade, com **Traefik** como reverse proxy fornecendo termina√ß√£o SSL autom√°tica e roteamento inteligente.

### üé™ Cen√°rio de Uso

- **Desenvolvimento local** em ambiente WSL/Windows
- **Produ√ß√£o** com dom√≠nios reais e certificados SSL autom√°ticos ou externos
- **Escalabilidade horizontal** com workers dedicados
- **Alta disponibilidade** com Redis como broker de mensagens

## ‚ú® Caracter√≠sticas

- ‚úÖ **n8n em modo fila** - Escalabilidade horizontal com workers dedicados
- ‚úÖ **Traefik Reverse Proxy** - Roteamento autom√°tico e termina√ß√£o SSL
- ‚úÖ **PostgreSQL** - Banco de dados robusto para persist√™ncia
- ‚úÖ **Redis** - Message broker para comunica√ß√£o entre workers
- ‚úÖ **Certificados SSL** - Duas op√ß√µes: autom√°ticos via Traefik ou externos via certbot
- ‚úÖ **Docker Compose** - Orquestra√ß√£o simplificada
- ‚úÖ **Monitoramento integrado** - Dashboard do Traefik inclu√≠do
- ‚úÖ **Cloudflare DDNS** - Atualiza√ß√£o autom√°tica de DNS
- ‚úÖ **Script de inicializa√ß√£o** - Setup automatizado com verifica√ß√µes
- ‚úÖ **Compatibilidade WSL** - Configura√ß√£o espec√≠fica para Windows/WSL

## üèóÔ∏è Arquitetura

```mermaid
graph TB
    Internet[üåê Internet] --> Traefik[üö¶ Traefik Proxy]
    
    Traefik --> Dashboard[üìä Traefik Dashboard]
    Traefik --> N8N[üîß n8n Main]
    
    N8N --> Worker1[üë∑ n8n Worker]
    N8N --> Worker2[üë∑ n8n Webhook]
    
    N8N --> Redis[üî¥ Redis Queue]
    N8N --> PostgreSQL[üêò PostgreSQL]
    
    Worker1 --> Redis
    Worker2 --> Redis
    
    Worker1 --> PostgreSQL
    Worker2 --> PostgreSQL
    
    Cloudflare[‚òÅÔ∏è Cloudflare DDNS] --> Internet
    
    subgraph "üîí SSL/TLS"
        LetsEncrypt[üìú Let's Encrypt]
    end
    
    LetsEncrypt --> Traefik
```

### üì¶ Componentes

| Componente | Fun√ß√£o | Porta |
|------------|---------|-------|
| **Traefik** | Reverse Proxy + SSL | 80, 443, 8080 |
| **n8n-main** | Interface principal | 5678 (interno) |
| **n8n-worker** | Processamento de workflows | - |
| **n8n-webhook** | Webhooks dedicados | - |
| **PostgreSQL** | Banco de dados | 5432 (interno) |
| **Redis** | Message queue | 6379 (interno) |
| **Cloudflare DDNS** | Atualiza√ß√£o DNS | - |

## ‚öôÔ∏è Pr√©-requisitos

### üñ•Ô∏è Sistema Operacional
- **Windows 11/10** com WSL2 habilitado
- **Ubuntu 20.04+** no WSL ou instala√ß√£o nativa Linux

### üê≥ Software Necess√°rio
- **Docker Desktop** (Windows) ou **Docker CE** (Linux)
- **Docker Compose** v2.0+
- **Git**
- **Curl** e **OpenSSL**

### üåê Requisitos de Rede
- **Dom√≠nio pr√≥prio** com acesso ao DNS
- **Portas abertas** no roteador: 80, 443
- **IP p√∫blico est√°tico** ou servi√ßo DDNS

### üìú Certificados SSL
- **Op√ß√£o 1**: Certificados autom√°ticos via Traefik (recomendado)
- **Op√ß√£o 2**: Certificados externos via Let's Encrypt (certbot)
- **Cloudflare API Token** (opcional, para DDNS)

## üöÄ Instala√ß√£o e Configura√ß√£o

### 1. Prepara√ß√£o do Ambiente WSL

#### üîß Instala√ß√£o do WSL2 (Windows)

```powershell
# Execute no PowerShell como Administrador
wsl --install -d Ubuntu
wsl --set-default-version 2
```

#### üê≥ Instala√ß√£o do Docker no WSL

```bash
# Atualizar sistema
sudo apt update && sudo apt upgrade -y

# Instalar depend√™ncias
sudo apt install -y curl wget git openssl

# Instalar Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# Adicionar usu√°rio ao grupo docker
sudo usermod -aG docker $USER

# Instalar Docker Compose
sudo curl -L "https://github.com/docker/docker-compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# Reiniciar WSL
exit
# No PowerShell: wsl --shutdown
# Abrir WSL novamente
```

### 2. Clonagem e Configura√ß√£o

```bash
# Clonar o projeto (ou baixar os arquivos)
git clone <seu-repositorio> n8n-queue-mode
cd n8n-queue-mode

# Verificar estrutura
ls -la
# Deve conter: docker-compose.yml, dynamic_conf.yml, start.sh, .env.example
```

### 3. Configura√ß√£o de Vari√°veis de Ambiente

```bash
# Copiar arquivo de exemplo
cp .env.example .env

# Editar configura√ß√µes
nano .env
```

#### üìù Exemplo de .env

```bash
# === CONFIGURA√á√ïES B√ÅSICAS ===
DOMAIN_NAME=meudominio.com
SUBDOMAIN=n8n

# === BANCO DE DADOS ===
POSTGRES_USER=n8n_user
POSTGRES_PASSWORD=senha_super_segura_123
POSTGRES_DB=n8n_db

# === N8N ===
N8N_ENCRYPTION_KEY=chave_criptografia_64_caracteres_muito_segura_mesmo_123456
EXECUTIONS_MODE=queue
GENERIC_TIMEZONE=America/Sao_Paulo

# === REDIS/QUEUE ===
QUEUE_BULL_REDIS_PASSWORD=redis_senha_123

# === TRAEFIK ===
TRAEFIK_AUTH_USERS=admin:$$2y$$10$$hash_bcrypt_da_senha

# === CLOUDFLARE (OPCIONAL) ===
CLOUDFLARE_API_TOKEN=seu_token_cloudflare
```

#### üîê Gerar Hash de Senha para Traefik

```bash
# Gerar hash bcrypt para senha "admin"
echo "admin" | openssl passwd -apr1 -stdin

# Ou usar htpasswd se dispon√≠vel
htpasswd -nb admin sua_senha
```

### 4. Configura√ß√£o DNS e Certificados SSL

#### üåê Configura√ß√£o DNS

No seu provedor de DNS, configure:

```
A    traefik.meudominio.com    ‚Üí SEU_IP_PUBLICO
A    n8n.meudominio.com       ‚Üí SEU_IP_PUBLICO
```

#### üìú Configura√ß√£o de Certificados SSL

Este projeto oferece **duas abordagens** para certificados SSL. Escolha a que melhor se adequa ao seu ambiente:

##### üöÄ Op√ß√£o 1: Certificados Autom√°ticos via Traefik (RECOMENDADA)

**üìã Caracter√≠sticas:**
- ‚úÖ Gera√ß√£o autom√°tica de certificados Let's Encrypt
- ‚úÖ Renova√ß√£o autom√°tica (sem interven√ß√£o manual)
- ‚úÖ Redirecionamento HTTP‚ÜíHTTPS autom√°tico
- ‚úÖ Configura√ß√£o mais simples
- ‚úÖ Menos pontos de falha
- ‚úÖ Ideal para ambientes de produ√ß√£o

**üìù Configura√ß√£o:**

1. **Use o arquivo docker-compose com SSL autom√°tico:**
   ```bash
   cp docker-compose-auto-ssl.yml docker-compose.yml
   ```

2. **Configure as vari√°veis no .env:**
   ```bash
   SSL_EMAIL=seu.email@dominio.com
   DOMAIN_NAME=meudominio.com
   SUBDOMAIN=n8n
   ```

3. **Remova configura√ß√£o din√¢mica externa (se existir):**
   ```bash
   mv dynamic_conf.yml dynamic_conf.yml.disabled
   ```

4. **Inicie os servi√ßos:**
   ```bash
   docker-compose up -d
   ```

**‚úÖ Pr√≥s:**
- Configura√ß√£o zero para certificados
- Renova√ß√£o autom√°tica (60 dias antes do vencimento)
- Suporte nativo a m√∫ltiplos dom√≠nios
- Logs centralizados no Traefik
- N√£o requer acesso root para renova√ß√£o

**‚ùå Contras:**
- Requer dom√≠nio p√∫blico v√°lido
- Depende da conectividade com Let's Encrypt
- Certificados ficam dentro do container (backup necess√°rio)

---

##### ‚öôÔ∏è Op√ß√£o 2: Certificados Externos via Let's Encrypt (certbot)

**üìã Caracter√≠sticas:**
- üîß Controle total sobre gera√ß√£o de certificados
- üîß Certificados armazenados no sistema host
- üîß Flexibilidade para certificados personalizados
- üîß Ideal para ambientes com requisitos espec√≠ficos

**üìù Configura√ß√£o:**

1. **Instalar certbot:**
   ```bash
   sudo apt install -y certbot
   ```

2. **Parar servi√ßos na porta 80/443:**
   ```bash
   sudo systemctl stop apache2 nginx 2>/dev/null || true
   ```

3. **Gerar certificados:**
   ```bash
   # Certificado para Traefik
   sudo certbot certonly --standalone \
     --preferred-challenges http \
     -d traefik.meudominio.com

   # Certificado para n8n
   sudo certbot certonly --standalone \
     --preferred-challenges http \
     -d n8n.meudominio.com
   ```

4. **Verificar certificados gerados:**
   ```bash
   sudo ls -la /etc/letsencrypt/live/
   ```

5. **Configurar dynamic_conf.yml:**
   ```yaml
   tls:
     certificates:
       - certFile: /etc/letsencrypt/live/traefik.meudominio.com/fullchain.pem
         keyFile: /etc/letsencrypt/live/traefik.meudominio.com/privkey.pem
       - certFile: /etc/letsencrypt/live/n8n.meudominio.com/fullchain.pem
         keyFile: /etc/letsencrypt/live/n8n.meudominio.com/privkey.pem
   ```

**‚úÖ Pr√≥s:**
- Certificados persistem no sistema host
- Controle total sobre o processo
- Funciona com certificados de qualquer CA
- Backup mais simples (arquivos no filesystem)
- Pode usar certificados wildcard

**‚ùå Contras:**
- Configura√ß√£o manual mais complexa
- Renova√ß√£o manual necess√°ria (ou cron job)
- Requer acesso root para gera√ß√£o
- Mais pontos de falha
- Conflitos potenciais com outros servi√ßos na porta 80/443

---

#### üéØ Qual Op√ß√£o Escolher?

| Cen√°rio | Op√ß√£o Recomendada | Motivo |
|---------|------------------|---------|
| **Produ√ß√£o** | Op√ß√£o 1 (Autom√°tica) | Menor manuten√ß√£o, mais confi√°vel |
| **Desenvolvimento** | Op√ß√£o 1 (Autom√°tica) | Configura√ß√£o mais simples |
| **Ambiente corporativo** | Op√ß√£o 2 (Externa) | Controle total, certificados personalizados |
| **M√∫ltiplos servi√ßos** | Op√ß√£o 2 (Externa) | Compartilhamento de certificados |
| **Primeiro uso** | Op√ß√£o 1 (Autom√°tica) | Menos complexidade |

#### üîß Migra√ß√£o Entre Op√ß√µes

**De Externa para Autom√°tica:**
```bash
# Backup da configura√ß√£o atual
cp docker-compose.yml docker-compose.yml.backup
mv dynamic_conf.yml dynamic_conf.yml.disabled

# Aplicar configura√ß√£o autom√°tica
cp docker-compose-auto-ssl.yml docker-compose.yml
docker-compose down && docker-compose up -d
```

**De Autom√°tica para Externa:**
```bash
# Parar Traefik para liberar porta 80
docker-compose stop traefik

# Gerar certificados externos
sudo certbot certonly --standalone -d traefik.meudominio.com
sudo certbot certonly --standalone -d n8n.meudominio.com

# Restaurar configura√ß√£o externa
cp docker-compose.yml.backup docker-compose.yml
mv dynamic_conf.yml.disabled dynamic_conf.yml
docker-compose up -d
```

### 5. Configura√ß√£o Espec√≠fica WSL/Windows

> ‚ö†Ô∏è **ATEN√á√ÉO**: Esta √© a parte mais importante para evitar problemas!

#### üñ•Ô∏è Configura√ß√£o do arquivo hosts do WSL

```bash
# Obter IP local do WSL
ip_wsl=$(hostname -I | awk '{print $1}')
echo "IP do WSL: $ip_wsl"

# Adicionar ao /etc/hosts do WSL
echo "$ip_wsl traefik.meudominio.com" | sudo tee -a /etc/hosts
echo "$ip_wsl n8n.meudominio.com" | sudo tee -a /etc/hosts
```

#### ü™ü Configura√ß√£o do arquivo hosts do Windows

> **üî• CR√çTICO**: O navegador Windows N√ÉO l√™ o `/etc/hosts` do WSL!

1. **Abrir Bloco de Notas como Administrador**
   ```
   Win + S ‚Üí "Bloco de Notas" ‚Üí Bot√£o direito ‚Üí "Executar como administrador"
   ```

2. **Abrir arquivo hosts do Windows**
   ```
   Arquivo ‚Üí Abrir ‚Üí C:\Windows\System32\drivers\etc\hosts
   Alterar filtro para "Todos os arquivos (*.*)"
   ```

3. **Adicionar entradas** (substitua `172.21.55.73` pelo seu IP WSL):
   ```
   # WSL n8n Project
   172.21.55.73 traefik.meudominio.com
   172.21.55.73 n8n.meudominio.com
   ```

4. **Salvar e limpar cache DNS**
   ```cmd
   # Abrir CMD como Administrador
   ipconfig /flushdns
   ```

### 6. Inicializa√ß√£o dos Servi√ßos

```bash
# Tornar script execut√°vel
chmod +x start.sh

# Inicializa√ß√£o completa com verifica√ß√µes
./start.sh

# Ou inicializa√ß√£o com limpeza
./start.sh --clean

# Ou com monitoramento
./start.sh --monitor
```

## üîß Uso

### üöÄ Comandos B√°sicos

```bash
# Iniciar todos os servi√ßos
./start.sh

# Parar todos os servi√ßos
docker-compose down

# Reiniciar um servi√ßo espec√≠fico
docker-compose restart n8n-main

# Ver logs em tempo real
docker-compose logs -f n8n-main

# Ver status dos containers
docker-compose ps

# Executar comando no container
docker-compose exec n8n-main /bin/bash
```

### üìä Verifica√ß√£o de Status

```bash
# Verificar se tudo est√° funcionando
curl -k https://traefik.meudominio.com/api/rawdata

# Testar n8n
curl -k https://n8n.meudominio.com/

# Ver routers do Traefik
curl http://localhost:8080/api/http/routers
```

## üåê URLs de Acesso

### üñ•Ô∏è Desenvolvimento (localhost)
- **Dashboard Traefik**: http://localhost:8080/dashboard/
- **API Traefik**: http://localhost:8080/api/rawdata

### üåç Produ√ß√£o (dom√≠nios)
- **Dashboard Traefik**: https://traefik.meudominio.com/dashboard/
  - üë§ Usu√°rio: `admin` / Senha: `sua_senha`
- **n8n Interface**: https://n8n.meudominio.com/

## ‚ö†Ô∏è Problemas Comuns e Solu√ß√µes

### üî¥ Erro: `ERR_CONNECTION_REFUSED` no navegador

**Problema**: Navegador Windows n√£o consegue acessar dom√≠nios HTTPS.

**Causa**: Navegador resolve DNS p√∫blico, mas n√£o h√° port forwarding.

**Solu√ß√£o**:
1. ‚úÖ Verificar se `/etc/hosts` do WSL est√° correto
2. ‚úÖ **CRUCIAL**: Editar `/C:/Windows/System32/drivers/etc/hosts` do Windows
3. ‚úÖ Executar `ipconfig /flushdns` como Administrador
4. ‚úÖ Reiniciar navegador

### üî¥ n8n retorna 404

**Problema**: Traefik n√£o roteia corretamente para n8n.

**Causa**: Configura√ß√£o de service no docker-compose incorreta.

**Solu√ß√£o**:
```yaml
labels:
  - "traefik.http.routers.n8n.service=n8n"  # ‚Üê Linha obrigat√≥ria
```

### üî¥ Certificados SSL n√£o funcionam

**Problema**: Erro de certificado SSL inv√°lido ou problemas de conectividade HTTPS.

#### **Para Certificados Autom√°ticos (Op√ß√£o 1):**

1. **Verificar se o Traefik est√° gerando certificados**:
   ```bash
   docker-compose logs traefik | grep -i certificate
   docker-compose logs traefik | grep -i acme
   ```

2. **Verificar conectividade com Let's Encrypt**:
   ```bash
   # Testar se o dom√≠nio resolve corretamente
   nslookup n8n.meudominio.com
   
   # Testar conectividade HTTP (para ACME challenge)
   curl -I http://n8n.meudominio.com/.well-known/acme-challenge/test
   ```

3. **Limpar cache de certificados e tentar novamente**:
   ```bash
   docker-compose down
   docker volume rm queue-mode_traefik_letsencrypt
   docker-compose up -d
   ```

4. **Verificar configura√ß√£o no .env**:
   ```bash
   # Certificar-se de que SSL_EMAIL est√° configurado
   grep SSL_EMAIL .env
   ```

#### **Para Certificados Externos (Op√ß√£o 2):**

1. **Certificados n√£o gerados**:
   ```bash
   sudo certbot certonly --standalone -d seu.dominio.com
   ```

2. **Permiss√µes incorretas**:
   ```bash
   sudo chown -R root:root /etc/letsencrypt/
   sudo chmod -R 755 /etc/letsencrypt/live/
   ```

3. **Configura√ß√£o dynamic_conf.yml incorreta**:
   ```yaml
   tls:
     certificates:
       - certFile: /etc/letsencrypt/live/dominio/fullchain.pem
         keyFile: /etc/letsencrypt/live/dominio/privkey.pem
   ```

4. **Verificar se arquivos existem**:
   ```bash
   sudo ls -la /etc/letsencrypt/live/seu.dominio.com/
   ```

#### **Problemas Comuns a Ambas Op√ß√µes:**

1. **Dom√≠nio n√£o resolve publicamente**:
   - Certificados SSL reais s√≥ funcionam com dom√≠nios p√∫blicos
   - Para teste local, use certificados auto-assinados ou HTTP

2. **Portas 80/443 bloqueadas**:
   ```bash
   # Verificar se portas est√£o abertas
   sudo netstat -tlnp | grep :80
   sudo netstat -tlnp | grep :443
   ```

3. **Firewall bloqueando acesso**:
   ```bash
   sudo ufw allow 80
   sudo ufw allow 443
   ```

#### **üîß Script de Corre√ß√£o Autom√°tica**

Para resolver problemas de certificados automaticamente:

```bash
# Executar script de corre√ß√£o
./fix-certificates.sh
```

Este script oferece:
- Migra√ß√£o autom√°tica para certificados autom√°ticos
- Gera√ß√£o de certificados auto-assinados para teste local
- Configura√ß√£o para HTTP (sem SSL) para desenvolvimento
- Diagn√≥stico completo de problemas

#### **üöÄ Solu√ß√£o R√°pida (Certificados Autom√°ticos)**

Se voc√™ quer a solu√ß√£o mais simples e confi√°vel:

```bash
# Migrar para certificados autom√°ticos
cp docker-compose.yml docker-compose.yml.backup
cp docker-compose-auto-ssl.yml docker-compose.yml
mv dynamic_conf.yml dynamic_conf.yml.disabled
docker-compose down && docker-compose up -d

# Aguardar alguns minutos e verificar
docker-compose logs -f traefik
```

### üî¥ PostgreSQL n√£o inicia

**Problema**: Container do PostgreSQL falha ao inicializar.

**Solu√ß√µes**:
```bash
# Verificar logs
docker-compose logs postgres

# Limpar volumes
docker-compose down -v
docker volume prune -f

# Recriar
docker-compose up -d postgres
```

### üî¥ Redis Connection Failed

**Problema**: n8n n√£o consegue conectar ao Redis.

**Verifica√ß√£o**:
```bash
# Testar conex√£o Redis
docker-compose exec redis redis-cli -a sua_senha_redis ping

# Verificar vari√°vel de ambiente
echo $QUEUE_BULL_REDIS_PASSWORD
```

### üî¥ IP do WSL mudou

**Problema**: Ap√≥s reinicializar Windows, IP do WSL muda.

**Solu√ß√£o**:
```bash
# Script para atualizar hosts automaticamente
#!/bin/bash
NEW_IP=$(hostname -I | awk '{print $1}')
sudo sed -i '/traefik.meudominio.com/d' /etc/hosts
sudo sed -i '/n8n.meudominio.com/d' /etc/hosts
echo "$NEW_IP traefik.meudominio.com" | sudo tee -a /etc/hosts
echo "$NEW_IP n8n.meudominio.com" | sudo tee -a /etc/hosts
```

## üõ†Ô∏è Manuten√ß√£o

### üîÑ Backup

```bash
# Backup do banco de dados
docker-compose exec postgres pg_dump -U n8n_user n8n_db > backup_$(date +%Y%m%d).sql

# Backup de volumes
docker run --rm -v queue-mode_n8n_data:/data -v $(pwd):/backup alpine tar czf /backup/n8n_backup_$(date +%Y%m%d).tar.gz /data
```

### üîÑ Restaura√ß√£o

```bash
# Restaurar banco de dados
cat backup_20250825.sql | docker-compose exec -T postgres psql -U n8n_user -d n8n_db

# Restaurar volumes
docker run --rm -v queue-mode_n8n_data:/data -v $(pwd):/backup alpine tar xzf /backup/n8n_backup_20250825.tar.gz -C /
```

### üîÑ Atualiza√ß√£o

```bash
# Parar servi√ßos
docker-compose down

# Atualizar imagens
docker-compose pull

# Iniciar com nova vers√£o
./start.sh
```

### üîÑ Renova√ß√£o de Certificados

#### **Certificados Autom√°ticos (Op√ß√£o 1)**

```bash
# Verificar logs de renova√ß√£o autom√°tica
docker-compose logs traefik | grep -i renew

# For√ßar renova√ß√£o (se necess√°rio)
docker-compose restart traefik

# Verificar certificados ativos
curl -vI https://n8n.meudominio.com 2>&1 | grep -i expire
```

**Observa√ß√µes:**
- Renova√ß√£o autom√°tica ocorre 30 dias antes do vencimento
- N√£o requer interven√ß√£o manual
- Logs de renova√ß√£o aparecem nos logs do Traefik

#### **Certificados Externos (Op√ß√£o 2)**

**üöÄ Script Automatizado de Renova√ß√£o**

O projeto inclui um script automatizado para renova√ß√£o de certificados externos:

```bash
# Executar renova√ß√£o autom√°tica
./renew-certificates.sh
```

**üìã O que o script faz:**
- ‚è∏Ô∏è Para o Traefik temporariamente para liberar as portas 80/443
- üîê Executa `certbot renew` para renovar todos os certificados
- üöÄ Reinicia o Traefik automaticamente
- üìã Exibe o status dos certificados renovados
- ‚úÖ Inclui tratamento de erros e logs informativos

**üîß Renova√ß√£o Manual (Alternativa)**

```bash
# Renovar certificados manualmente
sudo certbot renew --quiet

# Verificar validade dos certificados
sudo certbot certificates

# Configurar renova√ß√£o autom√°tica via cron
echo "0 12 * * * /usr/bin/certbot renew --quiet && docker-compose restart traefik" | sudo crontab -

# Reiniciar Traefik para carregar novos certificados
docker-compose restart traefik
```

**‚è∞ Configura√ß√£o de Cron para Automa√ß√£o**

```bash
# Tornar o script execut√°vel
chmod +x renew-certificates.sh

# Adicionar ao crontab para execu√ß√£o autom√°tica (todo dia 1¬∫ √†s 3:00)
echo "0 3 1 * * /caminho/para/queue-mode/renew-certificates.sh >> /var/log/certbot-renew.log 2>&1" | sudo crontab -

# Verificar crontab
sudo crontab -l
```

**üìä Monitoramento da Renova√ß√£o**

```bash
# Verificar logs da √∫ltima renova√ß√£o
tail -f /var/log/certbot-renew.log

# Verificar data de validade dos certificados
sudo certbot certificates

# Testar se certificados est√£o funcionando
curl -vI https://n8n.meudominio.com 2>&1 | grep -E 'expire|issuer'
```

**Observa√ß√µes:**
- ‚úÖ Script automatizado simplifica processo de renova√ß√£o
- ‚úÖ Renova√ß√£o via cron job com logs centralizados
- ‚úÖ Necess√°rio reiniciar Traefik ap√≥s renova√ß√£o
- ‚úÖ Requer acesso root para execu√ß√£o do certbot

## üìä Monitoramento

### üìà Logs

```bash
# Logs de todos os servi√ßos
docker-compose logs -f

# Logs espec√≠ficos
docker-compose logs -f n8n-main
docker-compose logs -f traefik

# Logs com timestamp
docker-compose logs -f --timestamps

# √öltimas 100 linhas
docker-compose logs --tail=100 n8n-main
```

### üìà M√©tricas

```bash
# Status dos containers
docker-compose ps

# Uso de recursos
docker stats

# Espa√ßo em disco
docker system df

# Verificar health checks
docker-compose ps postgres  # deve mostrar "healthy"
```

### üìà API do Traefik

- **Dashboard**: http://localhost:8080/dashboard/
- **API Raw**: http://localhost:8080/api/rawdata
- **Routers**: http://localhost:8080/api/http/routers
- **Services**: http://localhost:8080/api/http/services

## üîí Seguran√ßa

### üîê Recomenda√ß√µes de Produ√ß√£o

1. **Remover API insecure do Traefik**:
   ```yaml
   # Remover estas linhas do docker-compose.yml:
   - "--api.insecure=true"
   - "8080:8080"
   ```

2. **Senhas fortes**:
   ```bash
   # Gerar senhas seguras
   openssl rand -base64 32
   ```

3. **Firewall**:
   ```bash
   # Configurar UFW (Ubuntu)
   sudo ufw allow 80
   sudo ufw allow 443
   sudo ufw deny 8080  # Produ√ß√£o
   sudo ufw enable
   ```

4. **Backup seguro**:
   ```bash
   # Criptografar backups
   gpg --symmetric --cipher-algo AES256 backup.sql
   ```

### üîê Auditoria

```bash
# Verificar containers em execu√ß√£o
docker ps

# Verificar portas abertas
ss -tlnp

# Verificar logs de seguran√ßa
sudo tail -f /var/log/auth.log
```

## üìö Refer√™ncias

- üìñ [Documenta√ß√£o oficial n8n](https://docs.n8n.io/)
- üìñ [Documenta√ß√£o Traefik](https://doc.traefik.io/traefik/)
- üìñ [Docker Compose Reference](https://docs.docker.com/compose/)
- üìñ [Let's Encrypt Certbot](https://certbot.eff.org/)
- üìñ [WSL2 Documentation](https://docs.microsoft.com/en-us/windows/wsl/)

## ü§ù Contribui√ß√£o

### üìã Como Contribuir

1. Fork o projeto
2. Crie uma branch para sua feature (`git checkout -b feature/nova-feature`)
3. Commit suas mudan√ßas (`git commit -am 'Adiciona nova feature'`)
4. Push para a branch (`git push origin feature/nova-feature`)
5. Abra um Pull Request

### üêõ Reportar Problemas

Ao reportar problemas, inclua:

- ‚úÖ Vers√£o do sistema operacional
- ‚úÖ Vers√£o do Docker e Docker Compose
- ‚úÖ Logs relevantes (`docker-compose logs`)
- ‚úÖ Configura√ß√£o (sem senhas!)
- ‚úÖ Passos para reproduzir

### üìù Arquivos de Diagn√≥stico e Ferramentas

O projeto inclui v√°rias ferramentas para diagn√≥stico e corre√ß√£o:

#### üîß Scripts de Automa√ß√£o

- **`start.sh`** - Script principal com verifica√ß√µes autom√°ticas
  ```bash
  ./start.sh                 # Inicializa√ß√£o com diagn√≥sticos
  ./start.sh --clean         # Inicializa√ß√£o com limpeza
  ./start.sh --monitor       # Inicializa√ß√£o com monitoramento
  ```

- **`fix-certificates.sh`** - Corre√ß√£o autom√°tica de problemas SSL
  ```bash
  ./fix-certificates.sh      # Menu interativo de corre√ß√£o
  ```

- **`renew-certificates.sh`** - Renova√ß√£o autom√°tica de certificados Let's Encrypt
  ```bash
  ./renew-certificates.sh    # Renova√ß√£o autom√°tica com parada/rein√≠cio do Traefik
  chmod +x renew-certificates.sh  # Tornar execut√°vel na primeira vez
  ```

#### üìã Arquivos de Configura√ß√£o

- **`docker-compose.yml`** - Configura√ß√£o principal (certificados externos)
- **`docker-compose-auto-ssl.yml`** - Configura√ß√£o com SSL autom√°tico
- **`dynamic_conf.yml`** - Configura√ß√£o din√¢mica do Traefik (certificados externos)
- **`.env`** - Vari√°veis de ambiente do projeto

#### üìä Diagn√≥sticos Detalhados

- **`diagnostics.md`** - Log completo de troubleshooting
- **`TROUBLESHOOTING.md`** - Guia de solu√ß√£o de problemas comuns
- **Logs do Docker** - Para an√°lise t√©cnica detalhada

#### üéØ Escolha da Abordagem SSL

| Ferramenta | Certificados Autom√°ticos | Certificados Externos |
|------------|-------------------------|----------------------|
| **Configura√ß√£o** | `docker-compose-auto-ssl.yml` | `docker-compose.yml` + `dynamic_conf.yml` |
| **Inicia√ß√£o** | `./start.sh` | `./start.sh` |
| **Corre√ß√£o** | `./fix-certificates.sh` (op√ß√£o 1) | `./fix-certificates.sh` (op√ß√£o 2) |
| **Renova√ß√£o** | Autom√°tica (via Traefik) | `./renew-certificates.sh` ou cron manual |
| **Logs** | `docker-compose logs traefik` | `sudo certbot certificates` |

---

### üìû Suporte

Para d√∫vidas e suporte:

- üêõ **Issues**: Use as Issues do GitHub
- üìß **Email**: Contato do mantenedor
- üí¨ **Discord**: Link da comunidade (se houver)

---

**üéâ Parab√©ns! Seu ambiente n8n em modo queue com Traefik est√° pronto para uso!**

> üí° **Dica**: Mantenha este README.md atualizado conforme evolui a configura√ß√£o do projeto.
